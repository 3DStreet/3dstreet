<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Bollard Buddy Web</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* App Switcher in upper-left */
    #app-switcher-root {
      position: fixed;
      top: 8px;
      left: 6px;
      z-index: 100;
    }

    /* Object Picker UI - bottom left */
    #object-picker {
      position: fixed;
      bottom: 40px;
      left: 10px;
      z-index: 100;
      display: flex;
      flex-direction: column-reverse;
      gap: 6px;
    }

    .picker-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      backdrop-filter: blur(10px);
    }

    .picker-toggle:active {
      background: rgba(0, 0, 0, 0.8);
    }

    .picker-menu {
      display: none;
      flex-direction: column;
      gap: 3px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      padding: 6px;
      backdrop-filter: blur(10px);
    }

    .picker-menu.open {
      display: flex;
    }

    .picker-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 11px;
      cursor: pointer;
      text-align: left;
    }

    .picker-item:active,
    .picker-item.selected {
      background: rgba(59, 130, 246, 0.5);
    }

    .picker-hint {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 20px;
      color: white;
      font-size: 14px;
      backdrop-filter: blur(10px);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 100;
    }

    .picker-hint.visible {
      opacity: 1;
    }

    .picker-arrow {
      font-size: 12px;
      opacity: 0.7;
      margin-left: 4px;
    }

    /* Auth button container */
    #auth-root {
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 100;
    }

    /* Camera button container */
    #camera-container {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      display: none;
    }

    #camera-container.visible {
      display: block;
    }

    /* Ensure xrextras capture preview/share dialog appears above our UI */
    /* The xrextras previewContainer has z-index: 30 by default, but our UI uses z-index: 100 */
    #previewContainer {
      z-index: 1000 !important;
    }

    /* Gallery overrides for Bollard Buddy */
    /* Position gallery toggle in lower-right corner next to shutter */
    #gallery-toggle {
      top: auto !important;
      bottom: 40px !important;
      right: 10px !important;
      left: auto !important;
      z-index: 150 !important;
      width: 50px !important;
      height: 50px !important;
      display: flex !important;
      pointer-events: auto !important;
    }

    /* Position gallery sidebar from bottom-right, full height */
    #gallery-container {
      top: 0 !important;
      bottom: 100px !important;
      right: 0 !important;
      width: 66vw !important;
      height: auto !important;
      max-height: none !important;
      z-index: 100 !important;
    }

    /* Ensure gallery modal appears above everything */
    #gallery-root > div[class*="modal"] {
      z-index: 2000 !important;
    }
  </style>
</head>
<body>
  <!-- Object Picker UI -->
  <div id="object-picker">
    <button class="picker-toggle" id="picker-toggle">
      <span id="picker-icon">ğŸš§</span>
      <span id="picker-label">Bollard</span>
      <span class="picker-arrow">â–¼</span>
    </button>
    <div class="picker-menu" id="picker-menu">
      <button class="picker-item selected" data-model="bollard" data-icon="ğŸš§" data-label="Bollard">
        <span>ğŸš§</span> Bollard
      </button>
      <button class="picker-item" data-model="k71" data-icon="ğŸ”´" data-label="K71 Post">
        <span>ğŸ”´</span> K71 Post
      </button>
      <button class="picker-item" data-model="cone" data-icon="ğŸ”¶" data-label="Cone">
        <span>ğŸ”¶</span> Cone
      </button>
      <button class="picker-item" data-model="safehit" data-icon="ğŸ›¡ï¸" data-label="SafeHit">
        <span>ğŸ›¡ï¸</span> SafeHit
      </button>
    </div>
  </div>
  <div class="picker-hint" id="picker-hint">Tap on ground to place</div>

  <!-- App Switcher Mount Point (upper-left) -->
  <div id="app-switcher-root"></div>

  <!-- React Auth Island Mount Point -->
  <div id="auth-root"></div>

  <!-- Camera button container (button added dynamically after first object placed) -->
  <div id="camera-container"></div>

  <!-- 8th Wall SDK scripts -->
  <script src="https://cdn.8thwall.com/web/aframe/8frame-1.4.1.min.js"></script>
  <script src="https://cdn.8thwall.com/web/xrextras/xrextras.js"></script>
  <script src="https://cdn.8thwall.com/web/landing-page/landing-page.js"></script>
  <script src="https://cdn.8thwall.com/web/coaching-overlay/coaching-overlay.js"></script>
  <script src="https://apps.8thwall.com/xrweb?appKey=ytGX1RewlSvtViblkupyoCZFFPktzeZbcCf3wX4TVXI1CKtIiQlGEKdKj6Y9cJadtd8j6S"></script>

  <!-- Object Picker Logic -->
  <script>
    // Pre-select bollard
    window.selectedModel = 'bollard';

    const pickerToggle = document.getElementById('picker-toggle');
    const pickerMenu = document.getElementById('picker-menu');
    const pickerIcon = document.getElementById('picker-icon');
    const pickerLabel = document.getElementById('picker-label');
    const pickerHint = document.getElementById('picker-hint');
    const pickerItems = document.querySelectorAll('.picker-item');

    pickerToggle.addEventListener('click', () => {
      pickerMenu.classList.toggle('open');
    });

    pickerItems.forEach(item => {
      item.addEventListener('click', () => {
        const model = item.dataset.model;
        const icon = item.dataset.icon;
        const label = item.dataset.label;

        // Toggle selection
        if (window.selectedModel === model) {
          window.selectedModel = null;
          pickerIcon.textContent = '+';
          pickerLabel.textContent = 'Select Object';
          pickerHint.classList.remove('visible');
          pickerItems.forEach(i => i.classList.remove('selected'));
        } else {
          window.selectedModel = model;
          pickerIcon.textContent = icon;
          pickerLabel.textContent = label;
          pickerHint.classList.add('visible');
          pickerItems.forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
        }

        pickerMenu.classList.remove('open');
        console.log('Selected model:', window.selectedModel);
      });
    });

    // Close menu when tapping outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#object-picker')) {
        pickerMenu.classList.remove('open');
      }
    });

    // Track state
    window.hasPlacedObject = false;
    window.coachingVisible = true;

    const cameraContainer = document.getElementById('camera-container');

    // Show camera button (dynamically create it after coaching hides)
    window.showCameraButton = () => {
      if (!window.coachingVisible && !window.cameraButtonAdded) {
        window.cameraButtonAdded = true;
        const captureButton = document.createElement('xrextras-capture-button');
        captureButton.setAttribute('capture-mode', 'photo');
        cameraContainer.appendChild(captureButton);
        cameraContainer.classList.add('visible');
        console.log('Camera button added');
      }
    };

    // Show hint after coaching overlay hides (if user hasn't placed yet)
    const showHintAfterCoaching = () => {
      const scene = document.querySelector('a-scene');
      if (scene) {
        scene.addEventListener('coaching-overlay.hide', () => {
          window.coachingVisible = false;
          if (window.selectedModel && !window.hasPlacedObject) {
            pickerHint.classList.add('visible');
          }
          window.showCameraButton();
        });
        scene.addEventListener('coaching-overlay.show', () => {
          window.coachingVisible = true;
          pickerHint.classList.remove('visible');
        });
      }
    };

    // Wait for scene to be fully loaded before attaching listeners
    const initCoachingListeners = () => {
      const scene = document.querySelector('a-scene');
      if (scene) {
        if (scene.hasLoaded) {
          showHintAfterCoaching();
        } else {
          scene.addEventListener('loaded', showHintAfterCoaching);
        }
      } else {
        setTimeout(initCoachingListeners, 100);
      }
    };
    initCoachingListeners();
  </script>

  <!-- tap-place component -->
  <script>
    AFRAME.registerComponent('tap-place', {
      init() {
        const ground = document.getElementById('ground');

        const modelMap = {
          bollard: '#model-bollard',
          k71: '#model-k71',
          cone: '#model-cone',
          safehit: '#model-safehit',
        };

        ground.addEventListener('click', (event) => {
          const selectedModel = window.selectedModel;
          if (!selectedModel) {
            console.log('No model selected');
            return;
          }

          const modelSrc = modelMap[selectedModel];
          if (!modelSrc) {
            console.error('Unknown model:', selectedModel);
            return;
          }

          console.log('Ground clicked, placing:', selectedModel);

          const touchPoint = event.detail.intersection.point;
          console.log('Touch point:', touchPoint.x, touchPoint.y, touchPoint.z);

          const newElement = document.createElement('a-entity');
          newElement.setAttribute('position', `${touchPoint.x} ${touchPoint.y} ${touchPoint.z}`);
          newElement.setAttribute('scale', '1 1 1');
          newElement.setAttribute('gltf-model', modelSrc);
          newElement.setAttribute('class', 'cantap');
          newElement.setAttribute('shadow', 'cast: true; receive: false');
          newElement.setAttribute('xrextras-hold-drag', '');
          newElement.setAttribute('xrextras-two-finger-rotate', '');

          this.el.sceneEl.appendChild(newElement);
          console.log('Entity added to scene');

          // Hide hint after first placement
          if (!window.hasPlacedObject) {
            window.hasPlacedObject = true;
            const hint = document.getElementById('picker-hint');
            if (hint) hint.classList.remove('visible');
          }

          newElement.addEventListener('model-loaded', () => {
            console.log('Model loaded successfully!');
          });

          newElement.addEventListener('model-error', (err) => {
            console.error('Model failed to load:', err);
          });
        });

        console.log('tap-place component initialized');
      }
    });
  </script>

  <!-- A-Frame Scene -->
  <a-scene
    tap-place
    landing-page
    xrextras-gesture-detector
    coaching-overlay="animationColor: #E86FFF; promptText: For accurate scale push your phone forward and then pull back;"
    renderer="colorManagement: true"
    gltf-model="dracoDecoderPath: https://cdn.8thwall.com/web/aframe/draco-decoder/"
    xrweb="allowedDevices: any; scale: absolute">

    <a-assets>
      <a-asset-item id="model-bollard" src="https://assets.3dstreet.app/sets/dividers/gltf-exports/draco/dividers-bollard.glb"></a-asset-item>
      <a-asset-item id="model-k71" src="https://assets.3dstreet.app/sets/uoregon/gltf-exports/draco/traffic-post-k71.glb"></a-asset-item>
      <a-asset-item id="model-cone" src="https://assets.3dstreet.app/sets/dividers/gltf-exports/draco/dividers-traffic-cone.glb"></a-asset-item>
      <a-asset-item id="model-safehit" src="https://assets.3dstreet.app/sets/dividers/gltf-exports/draco/dividers-safehit.glb"></a-asset-item>
    </a-assets>

    <a-camera
      id="camera"
      position="0 1.6 0"
      raycaster="objects: .cantap"
      cursor="fuse: false; rayOrigin: mouse;">
    </a-camera>

    <a-entity
      light="type: directional; intensity: 1; castShadow: true; shadowMapHeight: 2048; shadowMapWidth: 2048"
      position="1 4.3 2.5">
    </a-entity>
    <a-entity light="type: ambient; intensity: 0.7"></a-entity>

    <a-box
      id="ground"
      class="cantap"
      scale="1000 2 1000"
      position="0 -1 0"
      material="shader: shadow; transparent: true; opacity: 0.4"
      shadow>
    </a-box>

    <!-- Photo capture config and preview -->
    <xrextras-capture-config
      file-name-prefix="bollardbuddy-"
      request-mic="false"
    ></xrextras-capture-config>
    <xrextras-capture-preview></xrextras-capture-preview>

  </a-scene>

  <!-- Load the bundled JavaScript for React auth island -->
  <script src="/dist/bollardbuddy.js"></script>
</body>
</html>
