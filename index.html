<!DOCTYPE html>
<html>
  <head>
    <!-- aframe -->
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>

    <!-- 3dstreet -->
    <script src="./dist/aframe-street-component.js"></script>

    <!-- user controls - vr teleport -->
    <!-- <script src="https://raw.githack.com/fernandojsg/aframe-teleport-controls/master/dist/aframe-teleport-controls.min.js"></script> -->

    <!-- user controls - cursor teleport -->
    <script src="./src/lib/aframe-cursor-teleport-component.min.js"></script>

    <!-- gltf-animation -->
    <script src="//cdn.8thwall.com/web/aframe/aframe-extras-6.1.1.min.js"></script>

    <!-- mapbox -->
    <script src="https://unpkg.com/aframe-mapbox-component/dist/aframe-mapbox-component.min.js"></script>

    <!-- save / load -->
    <script src="./src/json-utils.js"></script>

    <!-- ocean -->
    <script src="./src/components/ocean-plane.js"></script>

    <title>3DStreet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="ui_assets/favicon.ico">
    <link rel="stylesheet" href="src/viewer-styles.css">
  </head>

  <body>
    <!-- viewer ui start -->
    <div class="viewer-header-wrapper">
      <button class="viewer-logo-start-editor-button" onclick="startEditor()">
        <img class="viewer-logo-img" alt="3DStreet Viewer" src="ui_assets/3DStreet-Viewer-Start-Editor.svg">
      </button>
    </div>

    <div class="right-fixed">
      <ul class="right-menu">
        <li onclick="screenshot()"> <a class="camera"  href="#"> <span> Capture image as PNG </span> <img src="ui_assets/camera-icon.svg"> </a></li>
        <li onclick="inputStreetmix()"> <a class="load"  href="#"> <span> Load Streetmix URL </span> <img src="ui_assets/streetmix-logo.svg"> </a></li>
        <!-- <li onclick="inputJSON()"> <a class="load"  href="#"> <span> Load JSON String </span> <img src="assets/ui_assets/upload-icon.svg"> </a></li> -->
        <li><a class="load"> <label for="inputfile" style="display: inherit; align-items: center; cursor: pointer"> <input type="file" id="inputfile" style="display:none" accept=".js, .json, .txt"> <span> Load JSON File </span> <img src="ui_assets/upload-icon.svg"></label></a></li>
        <li> <a id="custom-enter-vr-button" class="vr" href="#"> <span class="vr">Enter VR mode</span> <img src="ui_assets/vr-icon.svg"> </a></li>
      </ul>
    </div>

    <a-scene
      vr-mode-ui="enterVRButton: #custom-enter-vr-button;"
      vr-mode-ui-if-headset
      renderer="colorManagement: true; physicallyCorrectLights: true;"
      gltf-model="dracoDecoderPath: https://www.gstatic.com/draco/versioned/decoders/1.4.3/"
      inspector="url: //3dstreet.app/dist/3dstreet-editor.js"
      >
      <a-assets>
        <!-- uncomment the line below to load assets from local github submodule -->
        <!-- <street-assets url="./assets/"></street-assets>   -->
        <!-- uncomment the line below to load all possible asset categories -->
        <!-- <street-assets categories="sidewalk-props people people-rigged vehicles vehicles-rigged buildings intersection-props segment-textures segment-colors lane-separator stencils vehicles-transit dividers sky grounds"></street-assets>   -->
        <!-- a reduced set of assets for non-animated streetmix streets without intersections -->
        <!-- <street-assets categories="sidewalk-props people vehicles vehicles-rigged buildings segment-textures segment-colors lane-separator stencils vehicles-transit dividers sky grounds"></street-assets> -->
        <!-- temporary -->
        <!-- sidewalk props -->
        <img id="wayfinding-map" src="https://assets.3dstreet.app/objects/wayfinding.jpg" crossorigin="anonymous" />
        <a-asset-item id="streetProps" src="https://assets.3dstreet.app/sets/street-props/gltf-exports/draco/street-props.glb"></a-asset-item>
        <a-mixin id="outdoor_dining" gltf-part="src: #streetProps; part: outdoor_dining"></a-mixin>
        <a-mixin id="bench_orientation_center" gltf-part="src: #streetProps; part: bench_orientation_center"></a-mixin>
        <a-mixin id="parklet" gltf-part="src: #streetProps; part: parklet"></a-mixin>
        <a-mixin id="utility_pole" gltf-part="src: #streetProps; part: utility_pole"></a-mixin>
        <a-mixin id="lamp-modern" gltf-part="src: #streetProps; part: street-light"></a-mixin>
        <a-mixin id="lamp-modern-double" gltf-part="src: #streetProps; part: street-light-double"></a-mixin>
        <a-mixin id="bikerack" gltf-part="src: #streetProps; part: bike_rack"></a-mixin>
        <a-mixin id="bikeshare" gltf-part="src: #streetProps; part: bike_share"></a-mixin>
        <a-mixin id="lamp-traditional" gltf-part="src: #streetProps; part: lamp_post_traditional" scale="2 2 2"></a-mixin>
        <a-mixin id="palm-tree" gltf-part="src: #streetProps; part: palmtree" scale="1 1.5 1"></a-mixin>
        <a-mixin id="bench" gltf-part="src: #streetProps; part: park_bench"></a-mixin>
        <a-mixin id="seawall" gltf-part="src: #streetProps; part: sea_wall"></a-mixin>
        <a-mixin id="track" gltf-part="src: #streetProps; part: track"></a-mixin>
        <a-mixin id="tree3" gltf-part="src: #streetProps; part: tree-01" scale="1.25 1.25 1.25"></a-mixin>
        <a-mixin id="bus-stop" gltf-part="src: #streetProps; part: transit-shelter-1"></a-mixin>
        <a-mixin id="pride-flag" position="0.409 3.345 0" rotation="0 0 0" scale="0.5 0.75 0" geometry="width:2;height:2;primitive:plane" material="side:double; src:https://assets.3dstreet.app/materials/rainbow-flag-poles_512.png;transparent: true;"></a-mixin>
        <a-mixin id="wayfinding-box" geometry="primitive: box; height: 2; width: 0.84; depth: 0.1" material="color: gray"></a-mixin>

        <!-- human characters -->
        <a-asset-item id="humans" src="https://assets.3dstreet.app/sets/human-characters-poses-1/gltf-exports/draco/human-characters-poses-1.glb"></a-asset-item>
        <a-mixin id="char1" gltf-part="src: #humans; part: Character_1"></a-mixin>
        <a-mixin id="char2" gltf-part="src: #humans; part: Character_2"></a-mixin>
        <a-mixin id="char3" gltf-part="src: #humans; part: Character_3"></a-mixin>
        <a-mixin id="char4" gltf-part="src: #humans; part: Character_4"></a-mixin>
        <a-mixin id="char5" gltf-part="src: #humans; part: Character_5"></a-mixin>
        <a-mixin id="char6" gltf-part="src: #humans; part: Character_6"></a-mixin>
        <a-mixin id="char7" gltf-part="src: #humans; part: Character_7"></a-mixin>
        <a-mixin id="char8" gltf-part="src: #humans; part: Character_8"></a-mixin>
        <a-asset-item id="humans2" src="https://assets.3dstreet.app/sets/human-characters-poses-2/gltf-exports/draco/human-characters-poses-2.glb"></a-asset-item>
        <a-mixin id="char9" gltf-part="src: #humans2; part: Character_9"></a-mixin>
        <a-mixin id="char10" gltf-part="src: #humans2; part: Character_10"></a-mixin>
        <a-mixin id="char11" gltf-part="src: #humans2; part: Character_11"></a-mixin>
        <a-mixin id="char12" gltf-part="src: #humans2; part: Character_12"></a-mixin>
        <a-mixin id="char13" gltf-part="src: #humans2; part: Character_13"></a-mixin>
        <a-mixin id="char14" gltf-part="src: #humans2; part: Character_14"></a-mixin>
        <a-mixin id="char15" gltf-part="src: #humans2; part: Character_15"></a-mixin>
        <a-mixin id="char16" gltf-part="src: #humans2; part: Character_16"></a-mixin>

        <a-asset-item id="character1walk" src="https://assets.3dstreet.app/sets/human-characters-animation-seperated/gltf-exports/draco/character-1-walk.glb"></a-asset-item>
        <a-mixin id="a_char1" gltf-model="#character1walk" animation-mixer></a-mixin>
        
        <a-asset-item id="character2walk" src="https://assets.3dstreet.app/sets/human-characters-animation-seperated/gltf-exports/draco/character-2-walk.glb"></a-asset-item>
        <a-mixin id="a_char2" gltf-model="#character2walk" animation-mixer></a-mixin>
        <a-asset-item id="character3walk" src="https://assets.3dstreet.app/sets/human-characters-animation-seperated/gltf-exports/draco/character-3-walk.glb"></a-asset-item>
        <a-mixin id="a_char3" gltf-model="#character3walk" animation-mixer></a-mixin>
        <a-asset-item id="character4walk" src="https://assets.3dstreet.app/sets/human-characters-animation-seperated/gltf-exports/draco/character-4-walk.glb"></a-asset-item>
        <a-mixin id="a_char4" gltf-model="#character4walk" animation-mixer></a-mixin>
        <a-asset-item id="character5walk" src="https://assets.3dstreet.app/sets/human-characters-animation-seperated/gltf-exports/draco/character-5-walk.glb"></a-asset-item>
        <a-mixin id="a_char5" gltf-model="#character5walk" animation-mixer></a-mixin>
        <a-asset-item id="character6walk" src="https://assets.3dstreet.app/sets/human-characters-animation-seperated/gltf-exports/draco/character-6-walk.glb"></a-asset-item>
        <a-mixin id="a_char6" gltf-model="#character6walk" animation-mixer></a-mixin>
        <a-asset-item id="character7walk" src="https://assets.3dstreet.app/sets/human-characters-animation-seperated/gltf-exports/draco/character-7-walk.glb"></a-asset-item>
        <a-mixin id="a_char7" gltf-model="#character7walk" animation-mixer></a-mixin>
        <a-asset-item id="character8walk" src="https://assets.3dstreet.app/sets/human-characters-animation-seperated/gltf-exports/draco/character-8-walk.glb"></a-asset-item>
        <a-mixin id="a_char8" gltf-model="#character8walk" animation-mixer></a-mixin>

        <!-- vehicles -->
        <a-asset-item id="vehicles" src="https://assets.3dstreet.app/sets/vehicles/gltf-exports/draco/vehicles.glb"></a-asset-item>
        <a-mixin id="box-truck" gltf-part="src: #vehicles; part: box-truck"></a-mixin>
        <a-mixin id="city-bus" gltf-part="src: #vehicles; part: city-bus"></a-mixin>
        <a-mixin id="food-trailer" gltf-part="src: #vehicles; part: food-trailer"></a-mixin>
        <a-mixin id="sedan-taxi" gltf-part="src: #vehicles; part: sedan-taxi"></a-mixin>
        <a-mixin id="suv" gltf-part="src: #vehicles; part: suv"></a-mixin>
        <a-asset-item id="magic-carpet-glb" src="https://assets.3dstreet.app/sets/magic-carpet/gltf-exports/draco/magic-carpet.glb"></a-asset-item>
        <a-mixin id="Character_1_M" gltf-part="src: #magic-carpet-glb; part: Character_1_M"></a-mixin>
        <a-mixin id="magic-carpet" gltf-part="src: #magic-carpet-glb; part: magic-carpet"></a-mixin>
        <!-- micro mobility vehicles -->
        <a-asset-item id="microMobilityDevices" src="https://assets.3dstreet.app/sets/micro-mobility-devices/gltf-exports/draco/micro-mobility-devices_v01.glb"></a-asset-item>
        <a-mixin id="Bicycle_1" gltf-part="src: #microMobilityDevices; part: Bicycle_1"></a-mixin>
        <a-mixin id="ElectricScooter_1" gltf-part="src: #microMobilityDevices; part: ElectricScooter_1"></a-mixin>

        <!-- vehicles rigged -->
        <a-asset-item id="sedan-rigged" src="https://assets.3dstreet.app/sets/vehicles-rig/gltf-exports/draco/toyota-prius-rig.glb"></a-asset-item>
        <a-mixin id="sedan-rig" gltf-model="#sedan-rigged" ></a-mixin>
        <a-asset-item id="bus-rigged" src="https://assets.3dstreet.app/sets/vehicles-rig/gltf-exports/draco/city-bus-rig.glb"></a-asset-item>
        <a-mixin id="bus-rig" gltf-model="#bus-rigged" ></a-mixin>
        <a-asset-item id="sedan-taxi-rigged" src="https://assets.3dstreet.app/sets/vehicles-rig/gltf-exports/draco/sedan-taxi-rig.glb"></a-asset-item>
        <a-mixin id="sedan-taxi-rig" gltf-model="#sedan-taxi-rigged" ></a-mixin>
        <a-asset-item id="suv-rigged" src="https://assets.3dstreet.app/sets/vehicles-rig/gltf-exports/draco/suv-rig.glb"></a-asset-item>
        <a-mixin id="suv-rig" gltf-model="#suv-rigged" ></a-mixin>
        <a-asset-item id="box-truck-rigged" src="https://assets.3dstreet.app/sets/vehicles-rig/gltf-exports/draco/isuzu-truck-rig.glb"></a-asset-item>
        <a-mixin id="box-truck-rig" gltf-model="#box-truck-rigged" ></a-mixin>

        <!-- blocks -->
        <a-asset-item id="blockmodel" src="https://assets.3dstreet.app/sets/buildings/gltf-exports/draco/buildings.glb"></a-asset-item>
        <a-asset-item id="archedmodel" src="https://assets.3dstreet.app/sets/arcade-style-buildings/gltf-exports/draco/arched-buildings.glb"></a-asset-item>
        <a-asset-item id="suburbiamodel" src="https://assets.3dstreet.app/sets/suburban-houses/gltf-exports/draco/suburban-houses.glb"></a-asset-item>

        <!-- buildings and blocks -->
        <a-mixin id="SM3D_Bld_Mixed_Corner_4fl" scale="1 1 1" rotation="0 0 0" gltf-part="src: #blockmodel; part: SM3D_Bld_Mixed_Corner_4fl"></a-mixin>
        <a-mixin id="SM3D_Bld_Mixed_Double_5fl" scale="1 1 1" rotation="0 0 0" gltf-part="src: #blockmodel; part: SM3D_Bld_Mixed_Double_5fl"></a-mixin>
        <a-mixin id="SM3D_Bld_Mixed_4fl_2" scale="1 1 1" rotation="0 0 0" gltf-part="src: #blockmodel; part: SM3D_Bld_Mixed_4fl_2"></a-mixin>
        <a-mixin id="SM3D_Bld_Mixed_5fl" scale="1 1 1" rotation="0 0 0" gltf-part="src: #blockmodel; part: SM3D_Bld_Mixed_5fl"></a-mixin>
        <a-mixin id="SM3D_Bld_Mixed_4fl" scale="1 1 1" rotation="0 0 0" gltf-part="src: #blockmodel; part: SM3D_Bld_Mixed_4fl"></a-mixin>

        <!-- suburban buildings -->
        <a-mixin id="SM_Bld_House_Preset_03_1800" scale="1 1 1" rotation="0 0 0" gltf-part="src: #suburbiamodel; part: suburban-house_1"></a-mixin>
        <a-mixin id="SM_Bld_House_Preset_08_1809" scale="1 1 1" rotation="0 0 0" gltf-part="src: #suburbiamodel; part: suburban-house_3"></a-mixin>
        <a-mixin id="SM_Bld_House_Preset_09_1845" scale="1 1 1" rotation="0 0 0" gltf-part="src: #suburbiamodel; part: suburban-house_2"></a-mixin>

        <!-- arched style buildings -->
        <a-mixin id="arched-building-01" scale="1 1 1" rotation="0 0 0" gltf-part="src: #archedmodel; part: arched-building-01"></a-mixin>
        <a-mixin id="arched-building-02" scale="1 1 1" rotation="0 0 0" gltf-part="src: #archedmodel; part: arched-building-02"></a-mixin>
        <a-mixin id="arched-building-03" scale="1 1 1" rotation="0 0 0" gltf-part="src: #archedmodel; part: arched-building-03"></a-mixin>
        <a-mixin id="arched-building-04" scale="1 1 1" rotation="0 0 0" gltf-part="src: #archedmodel; part: arched-building-04"></a-mixin>

        <a-asset-item id="stopsign" src="https://assets.3dstreet.app/sets/road-signs/gltf-exports/draco/stop-sign.glb"></a-asset-item>
        <a-asset-item id="signal1" src="https://assets.3dstreet.app/sets/signals/gltf-exports/draco/signal1.glb"></a-asset-item>
        <a-asset-item id="signal2" src="https://assets.3dstreet.app/sets/signals/gltf-exports/draco/signal2.glb"></a-asset-item>
        <a-mixin id="signal_left" gltf-model="#signal1"></a-mixin>
        <a-mixin id="signal_right" gltf-model="#signal2"></a-mixin>
        <a-mixin id="stop_sign" gltf-model="#stopsign"></a-mixin>

        <!-- segment mixins with textures -->
        <img id="seamless-road" src="https://assets.3dstreet.app/materials/TexturesCom_Roads0086_1_seamless_S_rotate.jpg" crossorigin="anonymous">
        <img id="seamless-bright-road" src="https://assets.3dstreet.app/materials/asphalthd_Base_Color.jpg" crossorigin="anonymous">
        <img id="hatched-base" src="https://assets.3dstreet.app/materials/hatched_Base_Color.jpg" crossorigin="anonymous">
        <img id="hatched-normal" src="https://assets.3dstreet.app/materials/hatched_Normal.jpg" crossorigin="anonymous">
        <img id="seamless-sidewalk" src="https://assets.3dstreet.app/materials/TexturesCom_FloorsRegular0301_1_seamless_S.jpg" crossorigin="anonymous">
        <a-mixin id="drive-lane" geometry="width:3;height:150;primitive:plane" material="repeat:0.3 25;offset:0.55 0;src:#seamless-road;"></a-mixin>
        <a-mixin id="bright-lane" geometry="width:3;height:150;primitive:plane" material="repeat:0.6 50;offset:0.55 0;src:#seamless-bright-road;color:#dddddd"></a-mixin>
        <a-mixin id="bike-lane" geometry="width:1.8;height:150;primitive:plane" material="repeat:0.3 25;offset:0.55 0;roughness:1;metalness:0;src:#seamless-road;"></a-mixin>
        <a-mixin id="sidewalk" anisotropy geometry="width:3;height:150;primitive:plane" material="repeat:1.5 75;src:#seamless-sidewalk;"></a-mixin>
        <a-mixin id="bus-lane" geometry="width:3;height:150;primitive:plane" material="repeat:0.3 25;offset:0.55 0;src:#seamless-road;"></a-mixin>
        <a-mixin id="divider" geometry="width:0.3;height:150;primitive:plane" material="repeat:1 150;offset:0.415 0;normalTextureOffset:0.415 0;src:#hatched-base;normalTextureRepeat:0.21 150;normalMap:#hatched-normal"></a-mixin>
        <a-mixin id="grass" geometry="width:0.3;height:150;primitive:plane" material="repeat:1 150;offset:0.415 0;src:#grass-texture;"></a-mixin>

        <!-- segment color modifier mixins -->
        <a-mixin id="yellow" material="color:#f7d117"></a-mixin>
        <a-mixin id="surface-green" material="color:#adff83"></a-mixin>
        <a-mixin id="surface-red" material="color:#ff9393"></a-mixin>

        <!-- lane separator markings -->
        <img id="markings-atlas" src="https://assets.3dstreet.app/materials/lane-markings-atlas_1024.png" crossorigin="anonymous" /> 
        <a-mixin id="markings" anisotropy atlas-uvs="totalRows: 1; totalColumns: 8; row: 1" scale="1 1 1" material="src: #markings-atlas;alphaTest: 0;transparent:true;repeat:1 25;" geometry="primitive: plane; buffer: false; skipCache: true; width:0.2; height:150;"></a-mixin>
        <a-mixin id="solid-stripe" atlas-uvs="column: 3"></a-mixin>
        <a-mixin id="dashed-stripe" atlas-uvs="column: 4"></a-mixin>
        <a-mixin id="short-dashed-stripe" atlas-uvs="column: 4" material="repeat:1 50;"></a-mixin>
        <a-mixin id="solid-doubleyellow" atlas-uvs="totalColumns: 4; column: 3" geometry="width: 0.5"></a-mixin>
        <a-mixin id="solid-dashed" atlas-uvs="totalColumns: 4; column: 2" geometry="width: 0.4"></a-mixin>
        <a-mixin id="crosswalk-zebra" atlas-uvs="totalColumns: 4; column: 4" geometry="width: 2; height: 12"  material="repeat: 1 2"></a-mixin>

        <!-- stencil markings -->
        <img id="stencils-atlas" src="https://assets.3dstreet.app/materials/stencils-atlas_2048.png" crossorigin="anonymous" />
        <a-mixin id="stencils" anisotropy atlas-uvs="totalRows: 4; totalColumns: 4" scale="2 2 2" material="src: #stencils-atlas;alphaTest: 0;transparent:true;" geometry="primitive: plane; buffer: false; skipCache: true"></a-mixin>
        <a-mixin id="right" atlas-uvs="column: 3; row: 2"></a-mixin>
        <a-mixin id="left" atlas-uvs="column: 3; row: 3"></a-mixin>
        <a-mixin id="both" atlas-uvs="column: 2; row: 1"></a-mixin>
        <a-mixin id="all" atlas-uvs="column: 3; row: 1"></a-mixin>
        <a-mixin id="left-straight" atlas-uvs="column: 2; row: 3"></a-mixin>
        <a-mixin id="right-straight" atlas-uvs="column: 2; row: 2"></a-mixin>
        <a-mixin id="straight" atlas-uvs="column: 2; row: 4"></a-mixin>
        <a-mixin id="sharrow" atlas-uvs="totalRows: 4; totalColumns: 8; column: 2; row: 3" scale="1.5 3 1"></a-mixin>
        <a-mixin id="bike-arrow" atlas-uvs="totalRows: 2; totalColumns: 8; column: 1; row: 2" scale="1 4 1"></a-mixin>
        <a-mixin id="word-bus" atlas-uvs="totalRows: 8; totalColumns: 8; column: 1; row: 4" scale="3 3 3"></a-mixin>
        <a-mixin id="word-lane" atlas-uvs="totalRows: 8; totalColumns: 8; column: 2; row: 4" scale="3 3 3"></a-mixin>
        <a-mixin id="word-taxi" atlas-uvs="totalRows: 8; totalColumns: 8; column: 1; row: 3" scale="3 3 3"></a-mixin>
        <a-mixin id="word-only" atlas-uvs="totalRows: 8; totalColumns: 8; column: 2; row: 3" scale="3 3 3"></a-mixin>
        <a-mixin id="word-only-small" atlas-uvs="totalRows: 8; totalColumns: 8; column: 2; row: 3" scale="2.5 2 2.5"></a-mixin>
        <a-mixin id="word-yield" atlas-uvs="totalRows: 8; totalColumns: 8; column: 1; row: 2" scale="3 3 3"></a-mixin>
        <a-mixin id="word-slow" atlas-uvs="totalRows: 8; totalColumns: 8; column: 2; row: 2" scale="3 3 3"></a-mixin>
        <a-mixin id="word-xing" atlas-uvs="totalRows: 8; totalColumns: 8; column: 1; row: 1" scale="3 3 3"></a-mixin>
        <a-mixin id="word-stop" atlas-uvs="totalRows: 8; totalColumns: 8; column: 2; row: 1" scale="3 3 3"></a-mixin>
        <a-mixin id="word-loading-small" atlas-uvs="totalRows: 8; totalColumns: 4; column: 4; row: 1" scale="2.75 1.75 2.75"></a-mixin>
        <a-mixin id="perpendicular-stalls" atlas-uvs="totalRows: 4; totalColumns: 8; column: 5; row: 4" scale="5 10 5"></a-mixin>
        <a-mixin id="parking-t" atlas-uvs="totalRows: 8; totalColumns: 16; column: 4; row: 7" scale="1.5 2 2"></a-mixin>
        <a-mixin id="painted-safety-zone" atlas-uvs="totalRows: 4; totalColumns: 4; column: 4; row: 4" scale="8 8 8"></a-mixin>
 
        <!-- vehicles-transit -->
        <a-asset-item id="trammodel" src="https://assets.3dstreet.app/objects/tram_siemens_avenio.gltf"></a-asset-item>
        <a-asset-item id="trolleymodel" src="https://assets.3dstreet.app/objects/godarvilletram.gltf"></a-asset-item>
        <a-asset-item id="xd40" src="https://assets.3dstreet.app/sets/flyer-bus/gltf-exports/draco/flyer-bus.glb"></a-asset-item>
        <a-mixin id="bus" anisotropy gltf-model="#xd40" scale="1.55 1.55 1.55"></a-mixin>
        <a-mixin id="tram" anisotropy gltf-model="#trammodel"></a-mixin>
        <a-mixin id="trolley" gltf-model="#trolleymodel"></a-mixin>
 
        <!-- dividers -->
        <a-asset-item id="dividers" src="https://assets.3dstreet.app/sets/dividers/gltf-exports/draco/dividers.glb"></a-asset-item>        
        <a-mixin id="dividers-flowers" scale="1 1 1" rotation="0 0 0" gltf-part="src: #dividers; part: flowers"></a-mixin>
        <a-mixin id="dividers-planting-strip" scale="1 1 1" rotation="0 0 0" gltf-part="src: #dividers; part: planting-strip"></a-mixin>
        <a-mixin id="dividers-planter-box" scale="1 1 1" rotation="0 0 0" gltf-part="src: #dividers; part: planter-box"></a-mixin>
        <a-mixin id="dividers-bush" scale="1 1 1" rotation="0 0 0" gltf-part="src: #dividers; part: bush"></a-mixin>
        <a-mixin id="dividers-dome" scale="1 1 1" rotation="0 0 0" gltf-part="src: #dividers; part: dome"></a-mixin>
        <a-mixin id="safehit" scale="1 1 1" rotation="0 0 0" gltf-part="src: #dividers; part: bollard"></a-mixin>
        <a-mixin id="temporary-barricade" scale="1 1 1" rotation="0 0 0" gltf-part="src: #dividers; part: barricade"></a-mixin>
        <a-mixin id="temporary-traffic-cone" scale="1 1 1" rotation="0 0 0" gltf-part="src: #dividers; part: traffic-cone"></a-mixin>
        <a-mixin id="temporary-jersey-barrier-plastic" scale="1 1 1" rotation="0 0 0" gltf-part="src: #dividers; part: jersey-barrier-plastic"></a-mixin>
        <a-mixin id="temporary-jersey-barrier-concrete" scale="1 1 1" rotation="0 0 0" gltf-part="src: #dividers; part: jersey-barrier-concrete"></a-mixin>
 
        <!-- sky -->
        <img id="sky" src="https://assets.3dstreet.app/CGSkies_0343_doubled_2048.jpg" crossorigin="anonymous" />
        <img id="sky-night" src="https://assets.3dstreet.app/images/AdobeStock_286725174-min.jpeg" crossorigin="anonymous" />
 
        <!-- grounds -->
        <img id="grass-texture" src="https://assets.3dstreet.app/materials/TexturesCom_Grass0052_1_seamless_S.jpg" crossorigin="anonymous">
        <img id="parking-lot-texture" src="https://assets.3dstreet.app/materials/TexturesCom_Roads0111_1_seamless_S.jpg" crossorigin="anonymous">
        <img id="asphalt-texture" src="https://assets.3dstreet.app/materials/TexturesCom_AsphaltDamaged0057_1_seamless_S.jpg" crossorigin="anonymous">

        <a-mixin id="ground-grass" rotation="-90 0 0" geometry="primitive:plane;height:150;width:40" material="src:#grass-texture;repeat:5 5;roughness:1"></a-mixin>
        <a-mixin id="ground-parking-lot" rotation="-90 0 0" geometry="primitive:plane;height:150;width:40" material="src:#parking-lot-texture;repeat:2 4;roughness:1"></a-mixin>
        <a-mixin id="ground-asphalt" rotation="-90 0 0" geometry="primitive:plane;height:150;width:40" material="src:#asphalt-texture;repeat:5 5;roughness:1"></a-mixin>
        <a-mixin id="ground-tiled-concrete" anisotropy rotation="-90 0 0" geometry="primitive:plane;height:150;width:40" material="src:#seamless-sidewalk;repeat:5 5;roughness:1"></a-mixin>

        <a-asset-item id="fence-model" src="https://assets.3dstreet.app/sets/fences/gltf-exports/draco/fence4.glb"></a-asset-item>
        <a-mixin id="fence" gltf-model="#fence-model" scale="0.1 0.1 0.1"></a-mixin>

      </a-assets>
  
      <a-entity id="cameraRig" position="0 10 30" data-layer-name="Viewer" cursor-teleport="cameraRig: #cameraRig; cameraHead: #camera;" look-controls="reverseMouseDrag: true" wasd-controls="enabled: true">
        <a-entity id="camera" camera="near: 1; far: 1000" position="0 1.6 0" ></a-entity>
        <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #ffccff" teleport-controls="cameraRig: #cameraRig; button: trigger"></a-entity>
        <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color: #ffccff" teleport-controls="cameraRig: #cameraRig; button: trigger"></a-entity>
      </a-entity>

      <a-entity id="environment" data-layer-name="Environment" street-environment="preset: day;"></a-entity>

      <a-entity id="street-container" data-layer-name="3D Street Layers" data-layer-show-children>
        <a-entity id="default-street" street streetmix-loader set-loader-from-hash></a-entity>
      </a-entity>

      <a-entity id="layers-2d" data-layer-name="2D Street Layers" data-layer-show-children>

    </a-scene>
  </body>
  <script>
    // only show VR button if headset connected
    AFRAME.registerComponent('vr-mode-ui-if-headset', {
      dependencies: ['vr-mode-ui'],
      init: function () {
        if (!AFRAME.utils.device.checkHeadsetConnected()) {
          this.el.setAttribute('vr-mode-ui', 'enabled', false);
        }
      }
    })

    AFRAME.registerComponent('set-loader-from-hash', {
      dependencies: ['streetmix-loader'],
      schema: {
        defaultURL: { type: 'string' }
      },
      init: function () {
        // get hash from window
        const streetURL = window.location.hash.substring(1);
        if (streetURL !== undefined && streetURL.length > 0) {
          console.log('[set-loader-from-hash]','Using URL from hash', streetURL)
          this.el.setAttribute('streetmix-loader', 'streetmixStreetURL', streetURL);
        } 
        // else {
        //   console.log('[set-loader-from-hash]','Using default URL', this.data.defaultURL)
        //   this.el.setAttribute('streetmix-loader', 'streetmixStreetURL', this.data.defaultURL);
        // }
      }
    });

    function screenshot() {
      AFRAME.scenes[0].setAttribute('screenshot','width',AFRAME.scenes[0].canvas.width)
      AFRAME.scenes[0].setAttribute('screenshot','height',AFRAME.scenes[0].canvas.height)
      document.querySelector('a-scene').components.screenshot.capture('perspective');
    }

    function startEditor() {
      var sceneEl = document.querySelector('a-scene');
      sceneEl.components.inspector.openInspector();
      document.querySelector('.viewer-header-wrapper').style.display = 'none';
    }
    // uncomment the below to autostart the editor within 2 seconds of page load
    // setTimeout(() => {
    //   startEditor();
    // }, "2000")
    
    function inputStreetmix() {
      streetmixURL = prompt("Please enter a Streetmix URL", "https://streetmix.net/kfarr/3/example-street");
      setTimeout(function() { window.location.hash = streetmixURL; });
      streetContainerEl = document.getElementById('street-container');
      while (streetContainerEl.firstChild) {
        streetContainerEl.removeChild(streetContainerEl.lastChild);
      }
      streetContainerEl.innerHTML = '<a-entity street streetmix-loader="streetmixStreetURL: '+streetmixURL+'""></a-entity>';
    }

    // JSON loading starts here
    function getValidJSON(stringJSON) {
      // Preserve newlines, etc. - use valid JSON
      // Remove non-printable and other non-valid JSON characters
      return stringJSON.replace(/\'/g, "")
                       .replace(/\n/g, "")
                       .replace(/[\u0000-\u0019]+/g,"");
    }
    
    function createElementsFromJSON(streetJSONString) {
      const validJSONString = getValidJSON(streetJSONString);
      streetContainerEl = document.getElementById('street-container');
      while (streetContainerEl.firstChild) {
        streetContainerEl.removeChild(streetContainerEl.lastChild);
      }
      var streetObject = JSON.parse(validJSONString);
      createEntities(streetObject.data[0].children, streetContainerEl);
    }

    function inputJSON() {
      const stringJSON = prompt("Please paste 3DStreet JSON string");
      if (stringJSON) {
        createElementsFromJSON(stringJSON);
      }      
    }

    function fileJSON() {
      let reader=new FileReader();
      reader.onload=function(){
        createElementsFromJSON(reader.result);
      }
      reader.readAsText(this.files[0]);
    }

    document.getElementById('inputfile')
            .addEventListener('change', fileJSON);
  </script>
</html>
