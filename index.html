<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="./dist/aframe-street-component.js"></script>

    <!-- user controls -->
    <script src="https://raw.githack.com/fernandojsg/aframe-teleport-controls/master/dist/aframe-teleport-controls.min.js"></script>
    <script src="src/lib/aframe-orbit-controls.min.js"></script>

    <!-- ocean, ground, sky -->
    <script src="src/components/ocean-plane.js"></script>
    <script src="src/lib/aframe-cubemap-component.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@600&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400&display=swap');

      /* move a-frame performance `stats` below toolbar */
      .rs-base {
        left: 20px;
        top: 80px;
      }

      .navbar {
        font-family: Rubik;
        align-items: center;
        color: #0f0a13;
        display: flex;
        flex-grow: 2;
        height: 32px;
        font-size: 9.33px;
        justify-content: space-between;
        left: 0;
        margin: 0 auto;
        right: 40%;
        bottom: 0;
        zoom: 150%;
        z-index: 999999;
        position: fixed;
        justify-content: space-between;
      }

      .navbar a {
        text-decoration: none;
      }

      .navbar-brand {
        color: #4B3461;
        z-index: 999999;
        font-size: 12px;
        padding: 10px;
        white-space: nowrap;
        font-weight: 600;
      }

      .url-input {
        width: 90%;
        background-color: #9956db;
        font-size: 12px;
        vertical-align: 15%;
      }

    .url-form {
      width: 100%;
      padding-left: 5%;
      padding-bottom: 5%;
      white-space: nowrap;
    }

    a:link { text-decoration: none; }
    a:visited { text-decoration: none; }
    a:hover { text-decoration: none; }
    a:active { text-decoration: none; }

    .textlarge {
      color: #ffffff;
      z-index: 999999;
      font-family: Rubik;
      font-size: 26px;
      padding: 10px;
      white-space: nowrap;
      font-weight: 600;
      top: 0px;
      left: 20px;
      position: absolute;
    }

    .pill {
      font-family: Rubik;
      color: #ffffff;
      font-size: 12px;
      z-index: 999999;
      border-radius: 3px;
      background-color: #8941FF;
      margin: 5px;
      padding: 0px;
      padding-right: 5px;
      padding-left: 5px;
      bottom: 5px;
      position: relative;
    }

    .inputBox {
    background: transparent;
    z-index: 999999;
    width: 60%;
    color: #ffffff;
    border-color: transparent;
    font-family: Rubik;
    font-size: 20px;
    position: absolute;
    bottom: 20px;
    left: 20px;
    }
    
    .social {
      font-family: Rubik;
      color: #ffffff;
      border-radius: 3px;
      background-color: #3232327c;
      position: absolute;
      top: 140px;
      right: -1px;
      z-index: 999999;
      zoom: 125%;
      border: none;
      padding: 0px 3px 0px 3px;
      cursor: pointer;
    }

    .social:hover {
      background-color: #8941FF;
    }

    .a-enter-vr-button {
      visibility: hidden;
    }

    .a-enter-vr-button:hover {
      background-color: #8941FF;
    }

  </style>

  </head>
  <body>
    <!-- UI Elements  -->
    <!-- 3D Street Logo -->
    <a href="https://3d.st" style="z-index: 999999;">
      <h1 class="textlarge" style="font-weight: 300;"> 3D
      <span style="font-weight: 900">Street</span>
      <span class="pill">viewer</span>
      </h1>
    </a>

    <!-- Street Name HTML-->
    <input class="inputBox" id="myInput">
    <!-- Street Name Script-->
    <script>
      var input = document.getElementById("myInput");
      function valueTitle() {
        if (location.href.split("#")[1] != undefined){
          return location.href.split("#")[1];
        } else{
          return "https://streetmix.net/kfarr/3"
        } 
      }
      input.setAttribute("value",valueTitle());
      input.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
          console.log("hi")
          location.href='#'+input.value;
          setTimeout(window.location.reload.bind(window.location));
          event.preventDefault();
          this.blur();
        }
      });
    </script>

    <!-- Share Buttons HTML -->
    <button class="social" onmouseout="downloadHoverOut(event)" onmouseover="downloadHoverOver(event)" onclick="glTF()">
      <a id="downloadButton" style="position: relative; bottom:10px"></a>
      <img src="./assets/download.svg" />
    </button>
    <button class="social" style="top: 180px;" onmouseout="cameraHoverOut(event)" onmouseover="cameraHoverOver(event)" onclick="screenshot()">
      <a id="cameraButton" style="position: relative; bottom:10px"></a>
      <img src="./assets/camera.svg" />
    </button>
    <button class="social" style="top: 220px;" onmouseout="vrHoverOut(event)" onmouseover="vrHoverOver(event)" onclick="vrClick()">
      <a id="vrButton" style="position: relative; bottom:10px"></a>
      <img src="./assets/vr.svg" />
    </button>

    <script>
      function glTF() {
        alert(document.querySelector('a-scene').components.inspector);
      }
      function downloadHoverOver() {
        document.getElementById('downloadButton').innerHTML = "Save the scene as a glTF";
      }
      function downloadHoverOut() {
        document.getElementById('downloadButton').innerHTML = "";
      }
      function screenshot() {
        document.querySelector('a-scene').components.screenshot.capture('perspective');
      }
      function cameraHoverOver() {
        document.getElementById('cameraButton').innerHTML = "Save the scene as a PNG";
      }
      function cameraHoverOut() {
        document.getElementById('cameraButton').innerHTML = "";
      }
      function vrClick() {
        document.getElementsByClassName('a-enter-vr-button')[0].click();
      }
      function vrHoverOver() {
        document.getElementById('vrButton').innerHTML = "Enter VR mode";
      }
      function vrHoverOut() {
        document.getElementById('vrButton').innerHTML = "";
      }
    </script>

    <!-- A-Frame Scene  -->
    <a-scene style="z-index: 0;" renderer="colorManagement: true; highRefreshRate: true; foveationLevel: 3; physicallyCorrectLights: true; logarithmicDepthBuffer: false;" fogoff="type: linear; color: #D5C69B; far: 200" gltf-model="dracoDecoderPath: https://www.gstatic.com/draco/versioned/decoders/1.4.3/">
      <a-assets>
        <streetmix-assets url="./"></streetmix-assets>

        <a-cubemap id="skycube">
          <img src="assets/images/skybox/posx.jpg">
          <img src="assets/images/skybox/negx.jpg">
          <img src="assets/images/skybox/posy.jpg">
          <img src="assets/images/skybox/negy.jpg">
          <img src="assets/images/skybox/posz.jpg">
          <img src="assets/images/skybox/negz.jpg">
        </a-cubemap>

      </a-assets>

      <a-entity id="cameraRig">
        <a-entity id="camera" camera="far: 1000" wasd-controls="enabled: false" orbit-controls="autoRotate: true;autoRotateSpeed:0.01;target: 0 0 0;initialPosition:0 4 15;minDistance:3;maxDistance:100;enableKeys:false"></a-entity>
        <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #ccffcc" teleport-controls="cameraRig: #cameraRig; button: trigger"></a-entity>
        <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color: #ccffcc" teleport-controls="cameraRig: #cameraRig; button: trigger"></a-entity>
      </a-entity>

      <!-- <a-entity class="playme" sound="src: #ambientmp3; positional: false; loop: true;"></a-entity> -->

      <a-entity light="type: ambient; color: #FFF; intensity: 2"></a-entity>
      <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="0.5 1 -1"></a-entity>

      <a-ocean-plane height="100" width="100" position="0 -1 0" material="envMap: #skycube;"></a-ocean-plane>

      <a-entity id="skybox" cubemap="folder: assets/images/skybox/"></a-entity>

      <a-entity id="street-parent" street streetmix-loader set-loader-from-hash="defaultURL: https://streetmix.net/kfarr/3"></a-entity>
    </a-scene>
  </body>
  <script>
    AFRAME.registerComponent('set-loader-from-hash', {
      dependencies: ['streetmix-loader'],
      schema: {
        defaultURL: { type: 'string' }
      },
      init: function () {
        // get hash from window
        const streetURL = window.location.hash.substring(1);
        if (streetURL !== undefined && streetURL.length > 0) {
          console.log('[set-loader-from-hash]','Using URL from hash', streetURL)
          this.el.setAttribute('streetmix-loader', 'streetmixStreetURL', streetURL);
        } else {
          console.log('[set-loader-from-hash]','Using default URL', this.data.defaultURL)
          this.el.setAttribute('streetmix-loader', 'streetmixStreetURL', this.data.defaultURL);
        }
      }
    });

    window.onload = function () {
      if (window.location.hash.substring(1).length === 0) window.location.hash = '#https://streetmix.net/kfarr/3';
      document.querySelector('#inputUrl').value = window.location.hash.substring(1);
    }

    function startAudio() {
      // set sounds enabled in global state
      state.sounds.enabled = true;

      // iterate through all entities with .playme class and start them playing
      var entities = document.querySelectorAll('.playme'), i;
      for (i = 0; i < entities.length; ++i) {
        entities[i].components.sound.playSound();
      }

      // set 2D DOM toolbar volume icon to green to indicate state
      document.getElementById("audio-icon").setAttribute("class","fa fa-volume-up");
      document.getElementById("audio-icon").setAttribute("style","color: lightgreen");
    }

    document.querySelector('a-scene').addEventListener('enter-vr', function () {
      console.log("ENTERED VR");
      // startAudio();
    });
  </script>
</html>
